<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="chatMapper">
	<resultMap id="chatRoomResultMap" type="chatRoomVO">
	    <result property="roomId" column="ROOM_ID" />
	    <result property="ucSeq" column="UC_SEQ" />
	    <result property="userNo" column="USER_NO" />
	    <result property="createdAt" column="CREATED_AT" />
    	<result property="lastMessageAt" column="LAST_MESSAGE_AT" />
	</resultMap>
	
	<resultMap id="chatResultMap" type="chat">
	    <result property="messageId" column="MESSAGE_ID" />
	    <result property="roomId" column="ROOM_ID" />
	    <result property="senderType" column="SENDER_TYPE" />
	    <result property="message" column="MESSAGE" />
	    <result property="sentAt" column="SENT_AT" />
	    <result property="userNo" column="USER_NO" />
	    <result property="ucSeq" column="UC_SEQ" />
	</resultMap>

	 <!-- 채팅방 조회 -->
    <select id="getChatRoom" parameterType="string" resultMap="chatRoomResultMap">
        SELECT * FROM CHAT_ROOM WHERE ROOM_ID = #{roomId}
    </select>

    <!-- 채팅방 생성 -->
    <insert id="createChatRoom" parameterType="chatRoomVO">
        INSERT INTO CHAT_ROOM (ROOM_ID, UC_SEQ, USER_NO, CREATED_AT)
        VALUES (#{roomId}, #{ucSeq}, #{userNo}, CURRENT_TIMESTAMP)
    </insert>

    <!-- 특정 채팅방의 메시지 목록 조회 -->
    <select id="getMessages" parameterType="string" resultMap="chatResultMap">
        SELECT * FROM CHAT WHERE ROOM_ID = #{roomId} ORDER BY SENT_AT
    </select>

    <!-- 메시지 저장 -->
    <insert id="saveMessage" parameterType="chat">
        INSERT INTO CHAT (MESSAGE_ID, ROOM_ID, SENDER_TYPE, MESSAGE, SENT_AT ,USER_NO, UC_SEQ)
        VALUES (message_id_seq.NEXTVAL, #{roomId}, #{senderType}, #{message}, #{sentAt}, #{userNo}, #{ucSeq})
    </insert>
    
    
    <select id="checkNewChat" parameterType="_int" resultMap="chatResultMap">
    	WITH LatestChat AS (
		    SELECT
		        C.MESSAGE_ID,
		        C.ROOM_ID,
		        C.USER_NO,
		        C.MESSAGE,
		        C.SENDER_TYPE,
		        C.SENT_AT,
		        C.UC_SEQ,
		        ROW_NUMBER() OVER (PARTITION BY C.ROOM_ID ORDER BY C.SENT_AT DESC) AS rn
		    FROM
		        CHAT C
		    WHERE
		        C.UC_SEQ = #{ucSeq}  
		)
		SELECT
		    L.MESSAGE_ID,
		    L.ROOM_ID,
		    CASE
		        WHEN L.SENDER_TYPE = 'user' THEN U.USER_NAME  
		        ELSE '식당'            
		    END AS SENDER_NAME,       
		    L.MESSAGE,                
		    L.SENDER_TYPE,            
		    L.SENT_AT,               
		    L.UC_SEQ
		FROM
		    LatestChat L
		LEFT JOIN
		    USERS U ON L.USER_NO = U.USER_NO AND L.SENDER_TYPE = 'user'  
		WHERE
		    L.rn = 1  
		ORDER BY
		    L.SENT_AT DESC    
    </select>



</mapper>